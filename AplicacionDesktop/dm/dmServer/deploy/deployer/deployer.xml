<project name="DM server deployer" default="deploy" basedir=".">

	<property file="deployer.properties"/>

	<!--======================================================================= -->
	<!-- Publico 																-->
	<!-- Utilice el ant solo mediante estos target publicos 					-->
	<!--======================================================================= -->

	<property name="temp.dir" value="temp"/>
	<property name="F911.dir" value="${temp.dir}\${context.F911}"/>

	<!-- Destino del deploy -->
	<property environment="env"/>
	<property name="catalina.home" value="${env.CATALINA_HOME}"/>
	<property name="webapps.dir" value="${catalina.home}\webapps"/>
	<property name="F911.dest" value="${webapps.dir}\${context.F911}" />
	
	<!-- Fecha -->
	<tstamp>
		<format property="today" pattern="yyyyMMddHHmmss" locale="es"/>
	</tstamp>

	<target name="clean">
		<delete dir="${temp.dir}" />
	</target>

	<!-- Deploys -->
	<target name="deploy" depends="clean">

		<mkdir dir="${F911.dir}"/>

		<!--unzip src="../package/F911.zip" dest="${F911.dir}"/-->

		<copy overwrite="true" todir="${F911.dir}">
			<fileset dir="../package/F911">
				<include name="**/*.*"/>
			</fileset>
		</copy>

		
		<!-- Reemplazos de configuracion -->
		<antcall target="procesar-filtros">
			<param name="dir-classes" value="${F911.dir}"/>
		</antcall>


		<!-- Backup de previos paquetes, si existen -->
		<available file="${F911.dest}" type="dir" property="previous.F911.exists"/>

		<antcall target="F911.backup" />

		<!-- Vaciar previas aplicaciones -->
		<delete dir="${F911.dest}" />

		<!-- Recrear directorios -->
		<mkdir dir="${F911.dest}" />

		<!-- Copiar paquetes parametrizados -->
		<move file="${F911.dir}" todir="${webapps.dir}" />
		<antcall target="clean" />
	</target>

	<target name="F911.backup" if="previous.F911.exists">
		<zip destfile="${webapps.dir}\${today}-${context.F911}.zip">
			<fileset dir="${F911.dest}">
				<include name="**/*.*"/>
			</fileset>
		</zip>
	</target>
	
	<target name="procesar-filtros">
		<!-- Reemplazos de configuracion -->

		<replace dir="${dir-classes}" summary="true">
			<exclude name="**/*.class" />
			<exclude name="**/*.jasper" />

			<replacefilter token="%app.version%" value="${app.version}"/>
		

			<replacefilter token="%sql.server%" value="${sql.server}"/>
			<replacefilter token="%sql.emergenciesDatabase%" value="${sql.emergenciesDatabase}"/>
			<replacefilter token="%sql.username%" value="${sql.username}"/>
			<replacefilter token="%sql.password%" value="${sql.password}"/>
			<replacefilter token="%context.name%" value="${context.F911}"/>
			<replacefilter token="%emergencies.log%" value="${catalina.home}\logs\${context.F911}.log"/>
			<replacefilter token="%hibernate.log%" value="${catalina.home}\logs\${context.F911}-hibernate.log"/>
			<replacefilter token="%cache.log%" value="${catalina.home}\logs\${context.F911}-cache.log"/>
			<replacefilter token="%sql.log%" value="${catalina.home}\logs\${context.F911}-sql.log"/>
			<replacefilter token="%exceededOperations.log%" value="${catalina.home}\logs\${context.F911}-exceededOperations.log"/>

		</replace>

		<!-- Escapar en log4j.properties las barras -->
		<replace dir="${dir-classes}" summary="true" includes="**\log4j.properties">
			<replacefilter token="\" value="/"/>
		</replace>
	</target>

</project>